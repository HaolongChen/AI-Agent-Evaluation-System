name: OpenVPN Connection Setup (Enterprise-Grade)

on:
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'Enable debug mode with verbose logging'
        required: false
        default: 'false'
      connection_timeout:
        description: 'Connection timeout in seconds'
        required: false
        default: '60'
      ping_test_enabled:
        description: 'Enable ping tests to internal resources'
        required: false
        default: 'true'
      internal_test_hosts:
        description: 'Comma-separated internal hosts to ping test (optional)'
        required: false
        default: ''
      health_check_interval:
        description: 'Health check interval in seconds during execution'
        required: false
        default: '30'

env:
  VPN_CONFIG_PATH: /etc/openvpn/client/config.ovpn
  VPN_LOG_PATH: /var/log/openvpn/connection.log
  VPN_PID_PATH: /var/run/openvpn-client.pid
  VPN_INTERFACE: tun0
  MAX_RETRY_ATTEMPTS: 3
  HEALTH_CHECK_LOG: /tmp/vpn-health-check.log

jobs:
  openvpn-connection:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: System preparation and security checks
        run: |
          set -e
          echo "=== System Preparation and Security Checks ==="
          
          # Check for any leaked credentials in filesystem
          echo "ğŸ”’ Checking for potential credential leaks..."
          if [ -f ~/.ovpn ] || [ -f ~/config.ovpn ] || [ -d ~/.openvpn ]; then
            echo "âš ï¸ WARNING: Potential OpenVPN files found in home directory"
            ls -la ~/*.ovpn ~/.openvpn 2>/dev/null || true
          fi
          
          # Verify system entropy for secure connections
          ENTROPY=$(cat /proc/sys/kernel/random/entropy_avail)
          echo "âœ“ System entropy: $ENTROPY"
          if [ "$ENTROPY" -lt 100 ]; then
            echo "âš ï¸ WARNING: Low system entropy ($ENTROPY). Installing haveged..."
            sudo apt-get install -y haveged
            sudo systemctl start haveged
          fi
          
          # Check disk space
          DISK_AVAIL=$(df -BM / | tail -n1 | awk '{print $4}' | sed 's/M//')
          echo "âœ“ Available disk space: ${DISK_AVAIL}MB"
          if [ "$DISK_AVAIL" -lt 500 ]; then
            echo "âš ï¸ WARNING: Low disk space (${DISK_AVAIL}MB available)"
          fi
          
          # Set up secure umask
          umask 077
          echo "âœ“ Secure umask configured (077)"
          
          # Create secure temporary directory
          export SECURE_TMPDIR=$(mktemp -d -t openvpn-XXXXXXXXXX)
          chmod 700 "$SECURE_TMPDIR"
          echo "SECURE_TMPDIR=$SECURE_TMPDIR" >> $GITHUB_ENV
          echo "âœ“ Secure temporary directory created: $SECURE_TMPDIR"
          
          echo "âœ“ System preparation completed"

      - name: Install OpenVPN and dependencies
        id: install
        run: |
          set -e
          echo "=== Installing OpenVPN and Dependencies ==="
          
          # Update package list with retries
          for i in {1..3}; do
            if sudo apt-get update; then
              echo "âœ“ Package list updated"
              break
            else
              echo "âš ï¸ Package update attempt $i failed, retrying..."
              sleep 5
            fi
          done
          
          # Install with error handling
          PACKAGES="openvpn openvpn-systemd-resolved iproute2 iputils-ping dnsutils net-tools"
          echo "Installing packages: $PACKAGES"
          
          if ! sudo apt-get install -y $PACKAGES; then
            echo "âŒ Failed to install required packages"
            exit 1
          fi
          
          # Verify installations
          echo ""
          echo "=== Version Information ==="
          openvpn --version | head -n 1
          ip -V
          ping -V | head -n 1
          
          # Check OpenVPN capabilities
          if ! openvpn --show-ciphers > /dev/null 2>&1; then
            echo "âš ï¸ WARNING: OpenVPN cipher information unavailable"
          else
            echo "âœ“ OpenVPN capabilities verified"
          fi
          
          # Verify kernel modules
          echo ""
          echo "=== Kernel Module Check ==="
          if ! lsmod | grep -q tun; then
            echo "Loading TUN/TAP kernel module..."
            sudo modprobe tun
          fi
          
          if lsmod | grep -q tun; then
            echo "âœ“ TUN/TAP kernel module loaded"
          else
            echo "âŒ TUN/TAP kernel module not available"
            exit 1
          fi
          
          # Check TUN device
          if [ -c /dev/net/tun ]; then
            echo "âœ“ TUN device available: /dev/net/tun"
            ls -l /dev/net/tun
          else
            echo "âŒ TUN device not found"
            exit 1
          fi
          
          echo "âœ“ All dependencies installed and verified"

      - name: Validate and setup OpenVPN configuration
        id: config_setup
        run: |
          set -e
          echo "=== OpenVPN Configuration Setup and Validation ==="
          
          # Create directory structure with secure permissions
          echo "Creating directory structure..."
          sudo mkdir -p /etc/openvpn/client
          sudo mkdir -p /var/log/openvpn
          sudo mkdir -p /var/run
          
          sudo chmod 700 /etc/openvpn/client
          sudo chmod 755 /var/log/openvpn
          echo "âœ“ Directory structure created"
          
          # Validate OVPN config secret exists and is not empty
          if [ -z "${{ secrets.OPENVPNCONFIG }}" ]; then
            echo "âŒ OPENVPNCONFIG secret is empty or not set"
            echo "Please configure the OPENVPNCONFIG secret in repository settings"
            exit 1
          fi
          
          echo "âœ“ OPENVPNCONFIG secret is present"
          
          # Write configuration to temporary location first for validation
          TEMP_CONFIG="${SECURE_TMPDIR}/config.ovpn"
          echo "${{ secrets.OPENVPNCONFIG }}" > "$TEMP_CONFIG"
          chmod 600 "$TEMP_CONFIG"
          
          # Validate OVPN configuration format
          echo ""
          echo "=== Configuration Validation ==="
          
          # Check for required sections
          VALIDATION_PASSED=true
          
          if ! grep -q "^remote " "$TEMP_CONFIG"; then
            echo "âŒ Missing required 'remote' directive"
            VALIDATION_PASSED=false
          else
            REMOTE_INFO=$(grep "^remote " "$TEMP_CONFIG" | head -n 1)
            echo "âœ“ Remote server: $REMOTE_INFO"
          fi
          
          # Check for authentication method
          if grep -q "<ca>" "$TEMP_CONFIG" && grep -q "</ca>" "$TEMP_CONFIG"; then
            echo "âœ“ CA certificate found (inline)"
          elif grep -q "^ca " "$TEMP_CONFIG"; then
            echo "âœ“ CA certificate reference found"
          else
            echo "âŒ No CA certificate found"
            VALIDATION_PASSED=false
          fi
          
          # Check client certificate/key
          if grep -q "<cert>" "$TEMP_CONFIG" && grep -q "</cert>" "$TEMP_CONFIG"; then
            echo "âœ“ Client certificate found (inline)"
          fi
          
          if grep -q "<key>" "$TEMP_CONFIG" && grep -q "</key>" "$TEMP_CONFIG"; then
            echo "âœ“ Client key found (inline)"
          fi
          
          # Check for auth-user-pass if password authentication
          if grep -q "auth-user-pass" "$TEMP_CONFIG"; then
            echo "âœ“ Password authentication enabled"
          fi
          
          # Verify protocol and port
          if grep -q "^proto " "$TEMP_CONFIG"; then
            PROTO=$(grep "^proto " "$TEMP_CONFIG" | awk '{print $2}')
            echo "âœ“ Protocol: $PROTO"
          fi
          
          # Check for potential misconfigurations
          if grep -q "^redirect-gateway" "$TEMP_CONFIG"; then
            echo "â„¹ï¸  Full tunnel mode detected (redirect-gateway)"
          fi
          
          # Validate no shell injection characters in critical fields
          if grep -E '^(remote|proto|port) .*[;&|`$]' "$TEMP_CONFIG"; then
            echo "âŒ Potential shell injection detected in configuration"
            VALIDATION_PASSED=false
          fi
          
          if [ "$VALIDATION_PASSED" = false ]; then
            echo ""
            echo "âŒ Configuration validation failed"
            echo "Please check your OPENVPNCONFIG secret"
            rm -f "$TEMP_CONFIG"
            exit 1
          fi
          
          echo ""
          echo "âœ“ Configuration validation passed"
          
          # Move validated config to final location
          sudo mv "$TEMP_CONFIG" "$VPN_CONFIG_PATH"
          sudo chmod 600 "$VPN_CONFIG_PATH"
          sudo chown root:root "$VPN_CONFIG_PATH"
          
          # Add enhanced configuration directives
          echo "" | sudo tee -a "$VPN_CONFIG_PATH" > /dev/null
          echo "# GitHub Actions Enterprise Configuration" | sudo tee -a "$VPN_CONFIG_PATH" > /dev/null
          echo "# Added by automated workflow" | sudo tee -a "$VPN_CONFIG_PATH" > /dev/null
          
          # DNS resolution fix for systemd-resolved
          echo "script-security 2" | sudo tee -a "$VPN_CONFIG_PATH" > /dev/null
          echo "setenv PATH /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin" | sudo tee -a "$VPN_CONFIG_PATH" > /dev/null
          echo "up /etc/openvpn/update-systemd-resolved" | sudo tee -a "$VPN_CONFIG_PATH" > /dev/null
          echo "down /etc/openvpn/update-systemd-resolved" | sudo tee -a "$VPN_CONFIG_PATH" > /dev/null
          echo "dhcp-option DOMAIN-ROUTE ." | sudo tee -a "$VPN_CONFIG_PATH" > /dev/null
          
          # Enhanced logging configuration
          echo "log-append $VPN_LOG_PATH" | sudo tee -a "$VPN_CONFIG_PATH" > /dev/null
          
          # Set verbosity based on debug mode
          if [ "${{ github.event.inputs.debug_enabled }}" = "true" ]; then
            echo "verb 4" | sudo tee -a "$VPN_CONFIG_PATH" > /dev/null
            echo "âœ“ Debug logging enabled (verbosity 4)"
          else
            echo "verb 3" | sudo tee -a "$VPN_CONFIG_PATH" > /dev/null
          fi
          
          # Connection reliability improvements
          echo "persist-key" | sudo tee -a "$VPN_CONFIG_PATH" > /dev/null
          echo "persist-tun" | sudo tee -a "$VPN_CONFIG_PATH" > /dev/null
          echo "keepalive 10 60" | sudo tee -a "$VPN_CONFIG_PATH" > /dev/null
          echo "resolv-retry infinite" | sudo tee -a "$VPN_CONFIG_PATH" > /dev/null
          
          # Security enhancements
          echo "remote-cert-tls server" | sudo tee -a "$VPN_CONFIG_PATH" > /dev/null
          echo "tls-client" | sudo tee -a "$VPN_CONFIG_PATH" > /dev/null
          
          # Verify final permissions
          PERMS=$(stat -c "%a" "$VPN_CONFIG_PATH")
          OWNER=$(stat -c "%U:%G" "$VPN_CONFIG_PATH")
          
          if [ "$PERMS" != "600" ]; then
            echo "âŒ Configuration file has incorrect permissions: $PERMS (expected 600)"
            exit 1
          fi
          
          if [ "$OWNER" != "root:root" ]; then
            echo "âš ï¸ WARNING: Configuration file owner is $OWNER (expected root:root)"
          fi
          
          echo ""
          echo "âœ“ Configuration file created with secure permissions"
          echo "  Location: $VPN_CONFIG_PATH"
          echo "  Permissions: $PERMS"
          echo "  Owner: $OWNER"
          
          # Create connection status file
          echo "disconnected" > "${SECURE_TMPDIR}/vpn_status"
          chmod 600 "${SECURE_TMPDIR}/vpn_status"

      - name: Start OpenVPN connection with retry logic
        id: vpn_connect
        run: |
          set -e
          
          TIMEOUT=${{ github.event.inputs.connection_timeout || '60' }}
          MAX_ATTEMPTS=${{ env.MAX_RETRY_ATTEMPTS }}
          
          echo "=== Starting OpenVPN Connection ==="
          echo "Configuration: $VPN_CONFIG_PATH"
          echo "Timeout: ${TIMEOUT}s"
          echo "Max retry attempts: $MAX_ATTEMPTS"
          echo ""
          
          # Function to start OpenVPN
          start_openvpn() {
            local attempt=$1
            echo "Connection attempt $attempt of $MAX_ATTEMPTS..."
            
            # Clean up any previous connection attempts
            if [ -f "$VPN_PID_PATH" ]; then
              OLD_PID=$(cat "$VPN_PID_PATH" 2>/dev/null || echo "")
              if [ -n "$OLD_PID" ] && kill -0 "$OLD_PID" 2>/dev/null; then
                echo "Stopping previous OpenVPN instance (PID: $OLD_PID)..."
                sudo kill -TERM "$OLD_PID" 2>/dev/null || true
                sleep 2
              fi
              sudo rm -f "$VPN_PID_PATH"
            fi
            
            # Remove existing interface if present
            if ip link show "$VPN_INTERFACE" > /dev/null 2>&1; then
              echo "Removing existing $VPN_INTERFACE interface..."
              sudo ip link delete "$VPN_INTERFACE" 2>/dev/null || true
              sleep 1
            fi
            
            # Start OpenVPN daemon
            if ! sudo openvpn --config "$VPN_CONFIG_PATH" --daemon --writepid "$VPN_PID_PATH" --status /var/run/openvpn-status.txt 10; then
              echo "âŒ Failed to start OpenVPN daemon"
              return 1
            fi
            
            # Give daemon time to initialize
            sleep 2
            
            # Verify daemon started
            if [ ! -f "$VPN_PID_PATH" ]; then
              echo "âŒ PID file not created"
              return 1
            fi
            
            VPN_PID=$(cat "$VPN_PID_PATH")
            if ! kill -0 "$VPN_PID" 2>/dev/null; then
              echo "âŒ OpenVPN process not running after start"
              return 1
            fi
            
            echo "âœ“ OpenVPN daemon started (PID: $VPN_PID)"
            return 0
          }
          
          # Function to wait for connection
          wait_for_connection() {
            local timeout=$1
            local counter=0
            local progress_marker=0
            
            echo "Waiting for VPN connection to establish..."
            
            while [ $counter -lt $timeout ]; do
              # Check if process is still alive
              if [ -f "$VPN_PID_PATH" ]; then
                VPN_PID=$(cat "$VPN_PID_PATH")
                if ! kill -0 "$VPN_PID" 2>/dev/null; then
                  echo ""
                  echo "âŒ OpenVPN process died unexpectedly"
                  echo ""
                  echo "Last 30 log entries:"
                  tail -n 30 "$VPN_LOG_PATH" 2>/dev/null || echo "No logs available"
                  return 1
                fi
              fi
              
              # Check interface and IP assignment
              if ip addr show "$VPN_INTERFACE" > /dev/null 2>&1; then
                if ip addr show "$VPN_INTERFACE" | grep -q "inet "; then
                  # Verify interface is UP
                  if ip link show "$VPN_INTERFACE" | grep -q "state UP\|state UNKNOWN"; then
                    VPN_IP=$(ip addr show "$VPN_INTERFACE" | grep "inet " | awk '{print $2}')
                    echo ""
                    echo "âœ“ VPN connection established after ${counter}s"
                    echo "  Interface: $VPN_INTERFACE"
                    echo "  IP Address: $VPN_IP"
                    
                    # Wait for routes to be fully configured
                    sleep 2
                    
                    # Verify routing
                    if ip route | grep -q "$VPN_INTERFACE"; then
                      echo "âœ“ VPN routes configured"
                      echo "connected" > "${SECURE_TMPDIR}/vpn_status"
                      return 0
                    else
                      echo "âš ï¸ VPN interface up but no routes found, waiting..."
                    fi
                  fi
                fi
              fi
              
              # Progress reporting
              counter=$((counter + 1))
              
              # Show progress every 5 seconds with different markers
              if [ $((counter % 5)) -eq 0 ]; then
                case $((progress_marker % 4)) in
                  0) echo -n "." ;;
                  1) echo -n "o" ;;
                  2) echo -n "O" ;;
                  3) echo -n "o" ;;
                esac
                progress_marker=$((progress_marker + 1))
              fi
              
              # Detailed status every 15 seconds
              if [ $((counter % 15)) -eq 0 ]; then
                echo ""
                echo "Status at ${counter}/${timeout}s:"
                echo "  - Process: $(kill -0 "$VPN_PID" 2>/dev/null && echo 'running' || echo 'stopped')"
                echo "  - Interface: $(ip link show "$VPN_INTERFACE" 2>/dev/null && echo 'exists' || echo 'not found')"
              fi
              
              sleep 1
            done
            
            echo ""
            echo "âŒ Connection timeout after ${timeout}s"
            return 1
          }
          
          # Main connection logic with retry
          CONNECTION_SUCCESS=false
          
          for attempt in $(seq 1 $MAX_ATTEMPTS); do
            if [ $attempt -gt 1 ]; then
              BACKOFF=$((attempt * 5))
              echo ""
              echo "Waiting ${BACKOFF}s before retry..."
              sleep $BACKOFF
              echo ""
            fi
            
            # Start OpenVPN
            if ! start_openvpn $attempt; then
              echo "Failed to start OpenVPN on attempt $attempt"
              continue
            fi
            
            # Wait for connection
            if wait_for_connection $TIMEOUT; then
              CONNECTION_SUCCESS=true
              break
            fi
            
            echo "Connection attempt $attempt failed"
            
            # Show relevant logs
            if [ -f "$VPN_LOG_PATH" ]; then
              echo ""
              echo "Recent log entries:"
              tail -n 20 "$VPN_LOG_PATH" | grep -i "error\|warn\|fail" || tail -n 10 "$VPN_LOG_PATH"
            fi
          done
          
          if [ "$CONNECTION_SUCCESS" = false ]; then
            echo ""
            echo "âŒ Failed to establish VPN connection after $MAX_ATTEMPTS attempts"
            echo ""
            echo "Full connection log:"
            echo "==================="
            tail -n 100 "$VPN_LOG_PATH" 2>/dev/null || echo "No logs available"
            exit 1
          fi
          
          echo ""
          echo "=== VPN Connection Established Successfully ==="

      - name: Comprehensive connection verification
        id: vpn_verify
        run: |
          set -e
          
          echo "=== Comprehensive VPN Connection Verification ==="
          echo ""
          
          VERIFICATION_FAILED=false
          
          # 1. Process verification
          echo "1ï¸âƒ£  Process Verification"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          if [ ! -f "$VPN_PID_PATH" ]; then
            echo "   âŒ PID file not found"
            VERIFICATION_FAILED=true
          else
            VPN_PID=$(cat "$VPN_PID_PATH")
            if kill -0 "$VPN_PID" 2>/dev/null; then
              echo "   âœ“ OpenVPN process running (PID: $VPN_PID)"
              
              # Check process details
              PS_INFO=$(ps -p "$VPN_PID" -o pid,ppid,rss,vsz,stat,start,time,cmd --no-headers)
              echo "   âœ“ Process details:"
              echo "     $PS_INFO" | sed 's/^/     /'
              
              # Check process uptime
              PROCESS_START=$(ps -p "$VPN_PID" -o lstart= 2>/dev/null || echo "unknown")
              echo "   âœ“ Process started: $PROCESS_START"
            else
              echo "   âŒ OpenVPN process not running"
              VERIFICATION_FAILED=true
            fi
          fi
          echo ""
          
          # 2. Interface verification
          echo "2ï¸âƒ£  Interface Verification"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          if ! ip link show "$VPN_INTERFACE" > /dev/null 2>&1; then
            echo "   âŒ VPN interface ($VPN_INTERFACE) not found"
            VERIFICATION_FAILED=true
          else
            echo "   âœ“ VPN interface exists: $VPN_INTERFACE"
            
            # Interface state
            IF_STATE=$(ip link show "$VPN_INTERFACE" | grep -oP 'state \K\w+')
            echo "   âœ“ Interface state: $IF_STATE"
            
            if [ "$IF_STATE" != "UP" ] && [ "$IF_STATE" != "UNKNOWN" ]; then
              echo "   âš ï¸ Interface is not UP (state: $IF_STATE)"
            fi
            
            # Interface details
            echo "   âœ“ Interface configuration:"
            ip addr show "$VPN_INTERFACE" | sed 's/^/     /'
            
            # Statistics
            echo "   âœ“ Interface statistics:"
            ip -s link show "$VPN_INTERFACE" | grep -A 2 "RX:\|TX:" | sed 's/^/     /'
          fi
          echo ""
          
          # 3. IP address verification
          echo "3ï¸âƒ£  IP Address Verification"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          VPN_IP=$(ip addr show "$VPN_INTERFACE" 2>/dev/null | grep "inet " | awk '{print $2}' | cut -d'/' -f1)
          if [ -z "$VPN_IP" ]; then
            echo "   âŒ No IP address assigned to $VPN_INTERFACE"
            VERIFICATION_FAILED=true
          else
            echo "   âœ“ VPN IP address: $VPN_IP"
            
            VPN_SUBNET=$(ip addr show "$VPN_INTERFACE" | grep "inet " | awk '{print $2}')
            echo "   âœ“ VPN subnet: $VPN_SUBNET"
            
            # Save VPN IP for later use
            echo "VPN_IP=$VPN_IP" >> $GITHUB_ENV
          fi
          echo ""
          
          # 4. Routing verification
          echo "4ï¸âƒ£  Routing Verification"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          VPN_ROUTES=$(ip route | grep "$VPN_INTERFACE" | wc -l)
          if [ "$VPN_ROUTES" -eq 0 ]; then
            echo "   âš ï¸ No routes found for $VPN_INTERFACE"
          else
            echo "   âœ“ Found $VPN_ROUTES route(s) via $VPN_INTERFACE:"
            ip route | grep "$VPN_INTERFACE" | sed 's/^/     /'
            
            # Check default route
            if ip route | grep -q "^default.*$VPN_INTERFACE"; then
              echo "   â„¹ï¸  Default route via VPN (full tunnel mode)"
            else
              echo "   â„¹ï¸  Split tunnel mode (no default route via VPN)"
            fi
          fi
          echo ""
          
          # 5. DNS verification
          echo "5ï¸âƒ£  DNS Configuration Verification"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          if command -v resolvectl > /dev/null 2>&1; then
            if resolvectl status "$VPN_INTERFACE" > /dev/null 2>&1; then
              echo "   âœ“ DNS configuration for $VPN_INTERFACE:"
              resolvectl status "$VPN_INTERFACE" | grep "DNS Servers\|DNS Domain" | sed 's/^/     /' || echo "     No DNS info available"
            else
              echo "   â„¹ï¸  No specific DNS configuration for $VPN_INTERFACE"
            fi
          else
            echo "   â„¹ï¸  resolvectl not available, checking resolv.conf"
            if grep -q "$VPN_INTERFACE" /etc/resolv.conf 2>/dev/null; then
              echo "   âœ“ VPN DNS configuration found in resolv.conf"
            fi
          fi
          echo ""
          
          # 6. Connection status file verification
          echo "6ï¸âƒ£  OpenVPN Status Verification"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          if [ -f /var/run/openvpn-status.txt ]; then
            echo "   âœ“ OpenVPN status file found"
            echo "   âœ“ Status information:"
            cat /var/run/openvpn-status.txt | head -n 20 | sed 's/^/     /'
          else
            echo "   â„¹ï¸  OpenVPN status file not available"
          fi
          echo ""
          
          # 7. Log analysis
          echo "7ï¸âƒ£  Connection Log Analysis"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          if [ -f "$VPN_LOG_PATH" ]; then
            # Check for initialization complete
            if grep -q "Initialization Sequence Completed" "$VPN_LOG_PATH"; then
              echo "   âœ“ OpenVPN initialization completed successfully"
            else
              echo "   âš ï¸ Initialization completion not confirmed in logs"
            fi
            
            # Check for errors/warnings
            ERROR_COUNT=$(grep -c "ERROR\|FATAL" "$VPN_LOG_PATH" || echo "0")
            WARN_COUNT=$(grep -c "WARNING" "$VPN_LOG_PATH" || echo "0")
            
            echo "   âœ“ Log summary:"
            echo "     - Errors: $ERROR_COUNT"
            echo "     - Warnings: $WARN_COUNT"
            
            if [ "$ERROR_COUNT" -gt 0 ]; then
              echo "   âš ï¸ Recent errors:"
              grep "ERROR\|FATAL" "$VPN_LOG_PATH" | tail -n 5 | sed 's/^/     /'
            fi
          else
            echo "   âš ï¸ Log file not found"
          fi
          echo ""
          
          # Final verdict
          if [ "$VERIFICATION_FAILED" = true ]; then
            echo "âŒ Verification failed - VPN connection has issues"
            exit 1
          else
            echo "âœ… All verification checks passed"
            echo ""
            echo "=== VPN Connection is Healthy and Ready ==="
          fi

      - name: Network connectivity and ping tests
        id: connectivity_tests
        if: github.event.inputs.ping_test_enabled != 'false'
        run: |
          set -e
          
          echo "=== Network Connectivity and Ping Tests ==="
          echo ""
          
          TEST_RESULTS="${SECURE_TMPDIR}/test_results.txt"
          echo "Test Results - $(date)" > "$TEST_RESULTS"
          echo "================================" >> "$TEST_RESULTS"
          echo "" >> "$TEST_RESULTS"
          
          # Function to test connectivity
          test_host() {
            local host=$1
            local test_type=$2
            local success=0
            
            echo "Testing $test_type: $host"
            
            # Ping test
            if ping -c 3 -W 5 -I "$VPN_INTERFACE" "$host" > /dev/null 2>&1; then
              echo "  âœ“ Ping successful (via $VPN_INTERFACE)"
              echo "âœ“ $test_type [$host]: PING SUCCESS" >> "$TEST_RESULTS"
              success=1
            else
              # Try without interface specification
              if ping -c 3 -W 5 "$host" > /dev/null 2>&1; then
                echo "  âœ“ Ping successful (default route)"
                echo "âœ“ $test_type [$host]: PING SUCCESS (default route)" >> "$TEST_RESULTS"
                success=1
              else
                echo "  âŒ Ping failed"
                echo "âœ— $test_type [$host]: PING FAILED" >> "$TEST_RESULTS"
              fi
            fi
            
            # Traceroute (first 5 hops)
            echo "  â„¹ï¸  Route trace (first 5 hops):"
            if command -v traceroute > /dev/null 2>&1; then
              timeout 10 traceroute -m 5 -w 2 "$host" 2>/dev/null | head -n 6 | tail -n 5 | sed 's/^/      /' || echo "      (traceroute unavailable)"
            fi
            
            # Latency measurement
            if [ $success -eq 1 ]; then
              LATENCY=$(ping -c 3 -W 5 "$host" 2>/dev/null | tail -n 1 | awk -F'/' '{print $5}' || echo "N/A")
              echo "  âœ“ Average latency: ${LATENCY}ms"
              echo "  Latency: ${LATENCY}ms" >> "$TEST_RESULTS"
            fi
            
            echo ""
            return $success
          }
          
          # 1. Test DNS resolution
          echo "1ï¸âƒ£  DNS Resolution Tests"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          
          # Test public DNS
          if nslookup google.com > /dev/null 2>&1; then
            echo "   âœ“ Public DNS resolution working (google.com)"
            echo "âœ“ DNS: Public resolution working" >> "$TEST_RESULTS"
          else
            echo "   âŒ Public DNS resolution failed"
            echo "âœ— DNS: Public resolution failed" >> "$TEST_RESULTS"
          fi
          
          # Test DNS servers
          DNS_SERVERS=$(resolvectl status "$VPN_INTERFACE" 2>/dev/null | grep "DNS Servers" | awk '{print $3}' || echo "")
          if [ -n "$DNS_SERVERS" ]; then
            echo "   âœ“ VPN DNS Server: $DNS_SERVERS"
          fi
          echo ""
          
          # 2. Test VPN gateway
          echo "2ï¸âƒ£  VPN Gateway Tests"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          
          # Get VPN gateway
          VPN_GATEWAY=$(ip route | grep "default.*$VPN_INTERFACE" | awk '{print $3}' || \
                       ip route | grep "$VPN_INTERFACE" | grep -v "scope link" | head -n1 | awk '{print $1}' | cut -d'/' -f1)
          
          if [ -n "$VPN_GATEWAY" ]; then
            test_host "$VPN_GATEWAY" "VPN Gateway"
          else
            echo "   â„¹ï¸  VPN gateway not identified"
            echo ""
          fi
          
          # 3. Test standard connectivity
          echo "3ï¸âƒ£  Standard Connectivity Tests"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          
          # Test common public servers (to verify internet access through VPN)
          test_host "8.8.8.8" "Google DNS"
          test_host "1.1.1.1" "Cloudflare DNS"
          
          # 4. Test custom internal hosts (if provided)
          INTERNAL_HOSTS="${{ github.event.inputs.internal_test_hosts }}"
          
          if [ -n "$INTERNAL_HOSTS" ]; then
            echo "4ï¸âƒ£  Internal Resource Tests"
            echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            
            # Parse comma-separated hosts
            IFS=',' read -ra HOST_ARRAY <<< "$INTERNAL_HOSTS"
            
            INTERNAL_SUCCESS=0
            INTERNAL_TOTAL=0
            
            for host in "${HOST_ARRAY[@]}"; do
              # Trim whitespace
              host=$(echo "$host" | xargs)
              if [ -n "$host" ]; then
                INTERNAL_TOTAL=$((INTERNAL_TOTAL + 1))
                if test_host "$host" "Internal Host"; then
                  INTERNAL_SUCCESS=$((INTERNAL_SUCCESS + 1))
                fi
              fi
            done
            
            echo "   Summary: $INTERNAL_SUCCESS/$INTERNAL_TOTAL internal hosts reachable"
            echo "" >> "$TEST_RESULTS"
            echo "Internal Hosts Summary: $INTERNAL_SUCCESS/$INTERNAL_TOTAL reachable" >> "$TEST_RESULTS"
          else
            echo "4ï¸âƒ£  Internal Resource Tests"
            echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "   â„¹ï¸  No internal hosts specified (use internal_test_hosts input)"
          fi
          echo ""
          
          # 5. Bandwidth test (simple)
          echo "5ï¸âƒ£  Basic Throughput Test"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          
          if command -v curl > /dev/null 2>&1; then
            echo "   Testing download speed..."
            # Download a small file and measure time
            START_TIME=$(date +%s)
            if timeout 10 curl -s -o /dev/null http://speedtest.tele2.net/1MB.zip 2>/dev/null; then
              END_TIME=$(date +%s)
              DURATION=$((END_TIME - START_TIME))
              if [ $DURATION -gt 0 ]; then
                SPEED=$((1024 / DURATION))
                echo "   âœ“ Download test: ~${SPEED} KB/s (1MB in ${DURATION}s)"
                echo "Throughput: ~${SPEED} KB/s" >> "$TEST_RESULTS"
              else
                echo "   âœ“ Download test: completed (< 1s)"
              fi
            else
              echo "   â„¹ï¸  Download test: unavailable or timed out"
            fi
          fi
          echo ""
          
          # Save test results as artifact data
          echo "TEST_RESULTS_FILE=$TEST_RESULTS" >> $GITHUB_ENV
          
          echo "=== Connectivity Tests Completed ==="
          echo ""
          echo "ğŸ“Š Full test results saved to: $TEST_RESULTS"
          cat "$TEST_RESULTS"

      - name: Start connection health monitoring
        id: health_monitor
        run: |
          set -e
          
          echo "=== Starting Connection Health Monitor ==="
          
          HEALTH_CHECK_INTERVAL=${{ github.event.inputs.health_check_interval || '30' }}
          HEALTH_LOG="$VPN_LOG_PATH"
          
          # Create health monitoring script
          cat > "${SECURE_TMPDIR}/health_monitor.sh" << 'HEALTH_EOF'
          #!/bin/bash
          
          INTERVAL=$1
          VPN_PID_PATH=$2
          VPN_INTERFACE=$3
          HEALTH_LOG=$4
          
          echo "Health monitor started at $(date)" >> "$HEALTH_LOG"
          echo "Check interval: ${INTERVAL}s" >> "$HEALTH_LOG"
          
          while true; do
            sleep "$INTERVAL"
            
            TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
            
            # Check 1: Process alive
            if [ -f "$VPN_PID_PATH" ]; then
              VPN_PID=$(cat "$VPN_PID_PATH")
              if ! kill -0 "$VPN_PID" 2>/dev/null; then
                echo "[$TIMESTAMP] CRITICAL: OpenVPN process died (PID: $VPN_PID)" >> "$HEALTH_LOG"
                exit 1
              fi
            else
              echo "[$TIMESTAMP] CRITICAL: PID file missing" >> "$HEALTH_LOG"
              exit 1
            fi
            
            # Check 2: Interface exists and is up
            if ! ip link show "$VPN_INTERFACE" &>/dev/null; then
              echo "[$TIMESTAMP] CRITICAL: VPN interface $VPN_INTERFACE disappeared" >> "$HEALTH_LOG"
              exit 1
            fi
            
            IF_STATE=$(ip link show "$VPN_INTERFACE" | grep -oP 'state \K\w+')
            if [ "$IF_STATE" != "UP" ] && [ "$IF_STATE" != "UNKNOWN" ]; then
              echo "[$TIMESTAMP] WARNING: Interface state changed to $IF_STATE" >> "$HEALTH_LOG"
            fi
            
            # Check 3: IP address still assigned
            if ! ip addr show "$VPN_INTERFACE" | grep -q "inet "; then
              echo "[$TIMESTAMP] CRITICAL: IP address lost on $VPN_INTERFACE" >> "$HEALTH_LOG"
              exit 1
            fi
            
            # Check 4: Routes still exist
            if ! ip route | grep -q "$VPN_INTERFACE"; then
              echo "[$TIMESTAMP] WARNING: No routes via $VPN_INTERFACE" >> "$HEALTH_LOG"
            fi
            
            # Check 5: Connectivity check (ping VPN gateway or DNS)
            VPN_GATEWAY=$(ip route | grep "default.*$VPN_INTERFACE" | awk '{print $3}' || echo "8.8.8.8")
            if ! ping -c 1 -W 3 "$VPN_GATEWAY" &>/dev/null; then
              echo "[$TIMESTAMP] WARNING: Cannot reach gateway $VPN_GATEWAY" >> "$HEALTH_LOG"
            fi
            
            # All checks passed
            RX_BYTES=$(cat /sys/class/net/$VPN_INTERFACE/statistics/rx_bytes 2>/dev/null || echo "0")
            TX_BYTES=$(cat /sys/class/net/$VPN_INTERFACE/statistics/tx_bytes 2>/dev/null || echo "0")
            echo "[$TIMESTAMP] OK: Connection healthy (RX: ${RX_BYTES}B, TX: ${TX_BYTES}B)" >> "$HEALTH_LOG"
          done
          HEALTH_EOF
          
          chmod 700 "${SECURE_TMPDIR}/health_monitor.sh"
          
          # Start health monitor in background
          nohup bash "${SECURE_TMPDIR}/health_monitor.sh" \
            "$HEALTH_CHECK_INTERVAL" \
            "$VPN_PID_PATH" \
            "$VPN_INTERFACE" \
            "$HEALTH_CHECK_LOG" \
            > /dev/null 2>&1 &
          
          MONITOR_PID=$!
          echo "$MONITOR_PID" > "${SECURE_TMPDIR}/monitor_pid"
          
          echo "âœ“ Health monitor started (PID: $MONITOR_PID)"
          echo "âœ“ Check interval: ${HEALTH_CHECK_INTERVAL}s"
          echo "âœ“ Log file: $HEALTH_CHECK_LOG"
          echo ""
          echo "The health monitor will:"
          echo "  - Verify OpenVPN process is running"
          echo "  - Check VPN interface status"
          echo "  - Monitor IP address assignment"
          echo "  - Verify routing configuration"
          echo "  - Test gateway connectivity"

      - name: Debug information (if enabled)
        if: github.event.inputs.debug_enabled == 'true'
        run: |
          echo "=== ğŸ” Debug Information ==="
          echo ""
          
          echo "1ï¸âƒ£  Environment Variables"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "   VPN_CONFIG_PATH: $VPN_CONFIG_PATH"
          echo "   VPN_LOG_PATH: $VPN_LOG_PATH"
          echo "   VPN_PID_PATH: $VPN_PID_PATH"
          echo "   VPN_INTERFACE: $VPN_INTERFACE"
          echo "   VPN_IP: ${VPN_IP:-not set}"
          echo ""
          
          echo "2ï¸âƒ£  OpenVPN Connection Log (last 100 lines)"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          tail -n 100 "$VPN_LOG_PATH" 2>/dev/null || echo "   No logs available"
          echo ""
          
          echo "3ï¸âƒ£  All Network Interfaces"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          ip addr show
          echo ""
          
          echo "4ï¸âƒ£  Complete Routing Table"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          ip route show table all
          echo ""
          
          echo "5ï¸âƒ£  ARP Table"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          ip neigh show
          echo ""
          
          echo "6ï¸âƒ£  OpenVPN Processes"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          ps aux | grep -E "[o]penvpn|[h]ealth_monitor" || echo "   No processes found"
          echo ""
          
          echo "7ï¸âƒ£  DNS Resolver Status"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          resolvectl status 2>/dev/null || systemd-resolve --status 2>/dev/null || cat /etc/resolv.conf
          echo ""
          
          echo "8ï¸âƒ£  Network Interface Statistics"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          for iface in $(ls /sys/class/net/); do
            if [ -d "/sys/class/net/$iface/statistics" ]; then
              echo "   Interface: $iface"
              echo "     RX bytes: $(cat /sys/class/net/$iface/statistics/rx_bytes)"
              echo "     TX bytes: $(cat /sys/class/net/$iface/statistics/tx_bytes)"
              echo "     RX packets: $(cat /sys/class/net/$iface/statistics/rx_packets)"
              echo "     TX packets: $(cat /sys/class/net/$iface/statistics/tx_packets)"
              echo "     RX errors: $(cat /sys/class/net/$iface/statistics/rx_errors)"
              echo "     TX errors: $(cat /sys/class/net/$iface/statistics/tx_errors)"
              echo ""
            fi
          done
          
          echo "9ï¸âƒ£  Health Check Log"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          if [ -f "$HEALTH_CHECK_LOG" ]; then
            cat "$HEALTH_CHECK_LOG"
          else
            echo "   No health check log available yet"
          fi
          echo ""
          
          echo "ğŸ”Ÿ System Resources"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "   Memory:"
          free -h
          echo ""
          echo "   Disk:"
          df -h /
          echo ""
          echo "   Load average:"
          uptime
          echo ""

      # ============================================
      # ğŸ¯ YOUR CUSTOM STEPS GO HERE
      # ============================================
      # Add your tasks that require VPN access below
      # The VPN connection is established and monitored
      # Example:
      # - name: Deploy to internal server
      #   run: |
      #     echo "Deploying through VPN..."
      #     # Your deployment commands
      #     # ssh user@internal-server 'bash deploy.sh'
      #     # curl http://internal-api/deploy
      
      - name: Example VPN task placeholder
        run: |
          echo "=== Example Task Through VPN ==="
          echo ""
          echo "âœ“ VPN is connected and monitored"
          echo "âœ“ You can now access internal resources"
          echo ""
          echo "Add your custom steps above this one to:"
          echo "  - Access internal servers"
          echo "  - Deploy to private networks"
          echo "  - Run tests against internal services"
          echo "  - Access private APIs"
          echo ""
          echo "Connection details:"
          echo "  - Interface: $VPN_INTERFACE"
          echo "  - IP Address: ${VPN_IP:-not available}"
          echo ""

      # ============================================
      # ğŸ§¹ CLEANUP - Always runs
      # ============================================

      - name: Stop health monitor
        if: always()
        run: |
          echo "=== Stopping Health Monitor ==="
          
          if [ -f "${SECURE_TMPDIR}/monitor_pid" ]; then
            MONITOR_PID=$(cat "${SECURE_TMPDIR}/monitor_pid")
            if kill -0 "$MONITOR_PID" 2>/dev/null; then
              echo "Stopping health monitor (PID: $MONITOR_PID)..."
              kill -TERM "$MONITOR_PID" 2>/dev/null || true
              
              # Wait for graceful stop
              for i in {1..5}; do
                if ! kill -0 "$MONITOR_PID" 2>/dev/null; then
                  break
                fi
                sleep 1
              done
              
              # Force kill if needed
              if kill -0 "$MONITOR_PID" 2>/dev/null; then
                kill -KILL "$MONITOR_PID" 2>/dev/null || true
              fi
              
              echo "âœ“ Health monitor stopped"
            fi
          fi
          
          # Show final health log
          if [ -f "$HEALTH_CHECK_LOG" ]; then
            echo ""
            echo "Final health check log:"
            tail -n 20 "$HEALTH_CHECK_LOG" || true
          fi

      - name: Comprehensive cleanup and security scrubbing
        if: always()
        run: |
          set +e  # Don't exit on errors during cleanup
          
          echo "=== Comprehensive Cleanup and Security Scrubbing ==="
          echo ""
          
          # Track cleanup success
          CLEANUP_ISSUES=0
          
          # 1. Stop OpenVPN gracefully
          echo "1ï¸âƒ£  Stopping OpenVPN Process"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          if [ -f "$VPN_PID_PATH" ]; then
            VPN_PID=$(cat "$VPN_PID_PATH" 2>/dev/null)
            if [ -n "$VPN_PID" ] && kill -0 "$VPN_PID" 2>/dev/null; then
              echo "   Sending SIGTERM to OpenVPN (PID: $VPN_PID)..."
              sudo kill -TERM "$VPN_PID" 2>/dev/null || true
              
              # Wait up to 15 seconds for graceful shutdown
              for i in {1..15}; do
                if ! kill -0 "$VPN_PID" 2>/dev/null; then
                  echo "   âœ“ OpenVPN stopped gracefully after ${i}s"
                  break
                fi
                sleep 1
              done
              
              # Force kill if still running
              if kill -0 "$VPN_PID" 2>/dev/null; then
                echo "   âš ï¸ Force killing OpenVPN (SIGKILL)..."
                sudo kill -KILL "$VPN_PID" 2>/dev/null || true
                sleep 1
              fi
            fi
          fi
          
          # Kill any remaining OpenVPN processes
          REMAINING_PIDS=$(pgrep openvpn || true)
          if [ -n "$REMAINING_PIDS" ]; then
            echo "   âš ï¸ Killing remaining OpenVPN processes: $REMAINING_PIDS"
            sudo killall -9 openvpn 2>/dev/null || true
            CLEANUP_ISSUES=$((CLEANUP_ISSUES + 1))
          else
            echo "   âœ“ No remaining OpenVPN processes"
          fi
          echo ""
          
          # 2. Remove network interface
          echo "2ï¸âƒ£  Network Interface Cleanup"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          if ip link show "$VPN_INTERFACE" > /dev/null 2>&1; then
            echo "   Removing $VPN_INTERFACE interface..."
            
            # Flush routes first
            sudo ip route flush dev "$VPN_INTERFACE" 2>/dev/null || true
            
            # Bring interface down
            sudo ip link set "$VPN_INTERFACE" down 2>/dev/null || true
            sleep 1
            
            # Delete interface
            sudo ip link delete "$VPN_INTERFACE" 2>/dev/null || true
            sleep 1
            
            # Verify removal
            if ip link show "$VPN_INTERFACE" > /dev/null 2>&1; then
              echo "   âš ï¸ Warning: $VPN_INTERFACE still exists after cleanup"
              CLEANUP_ISSUES=$((CLEANUP_ISSUES + 1))
            else
              echo "   âœ“ Network interface removed successfully"
            fi
          else
            echo "   âœ“ Network interface already removed"
          fi
          echo ""
          
          # 3. Clean up PID and status files
          echo "3ï¸âƒ£  PID and Status File Cleanup"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          FILES_TO_REMOVE=(
            "$VPN_PID_PATH"
            "/var/run/openvpn-status.txt"
            "/var/run/openvpn-client.log"
          )
          
          for file in "${FILES_TO_REMOVE[@]}"; do
            if [ -f "$file" ]; then
              sudo rm -f "$file"
              echo "   âœ“ Removed: $file"
            fi
          done
          echo ""
          
          # 4. Secure configuration file removal
          echo "4ï¸âƒ£  Configuration File Scrubbing"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          if [ -f "$VPN_CONFIG_PATH" ]; then
            echo "   Securely wiping configuration file..."
            
            # Get file size
            FILE_SIZE=$(stat -c%s "$VPN_CONFIG_PATH" 2>/dev/null || echo "0")
            
            # Overwrite with random data multiple times (DoD 5220.22-M standard)
            if command -v shred > /dev/null 2>&1; then
              sudo shred -vfz -n 3 "$VPN_CONFIG_PATH" 2>/dev/null || true
              echo "   âœ“ Configuration securely shredded (3 passes)"
            else
              # Fallback: overwrite with zeros
              sudo dd if=/dev/zero of="$VPN_CONFIG_PATH" bs="$FILE_SIZE" count=1 2>/dev/null || true
              echo "   âœ“ Configuration overwritten with zeros"
            fi
            
            # Remove the file
            sudo rm -f "$VPN_CONFIG_PATH"
          fi
          
          # Remove configuration directory
          if [ -d "/etc/openvpn/client" ]; then
            sudo rm -rf /etc/openvpn/client
            echo "   âœ“ Configuration directory removed"
          fi
          
          # Verify no config files remain
          CONFIG_LEAKED=$(find /etc/openvpn /tmp /var/tmp $HOME -name "*.ovpn" -o -name "config.ovpn" 2>/dev/null | wc -l)
          if [ "$CONFIG_LEAKED" -gt 0 ]; then
            echo "   âš ï¸ WARNING: Found $CONFIG_LEAKED potential config file(s):"
            find /etc/openvpn /tmp /var/tmp $HOME -name "*.ovpn" -o -name "config.ovpn" 2>/dev/null || true
            CLEANUP_ISSUES=$((CLEANUP_ISSUES + 1))
          else
            echo "   âœ“ No configuration files leaked"
          fi
          echo ""
          
          # 5. Log file cleanup
          echo "5ï¸âƒ£  Log File Cleanup"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          LOG_FILES=(
            "$VPN_LOG_PATH"
            "$HEALTH_CHECK_LOG"
            "/var/log/openvpn/connection.log"
            "/var/log/openvpn/openvpn.log"
          )
          
          for log in "${LOG_FILES[@]}"; do
            if [ -f "$log" ]; then
              # Check for sensitive data patterns
              if grep -qE "(password|secret|key|auth)" "$log" 2>/dev/null; then
                echo "   âš ï¸ Sensitive data detected in $log - securely removing"
              fi
              sudo rm -f "$log"
              echo "   âœ“ Removed: $log"
            fi
          done
          
          # Remove log directory if empty
          if [ -d "/var/log/openvpn" ]; then
            if [ -z "$(ls -A /var/log/openvpn)" ]; then
              sudo rmdir /var/log/openvpn
              echo "   âœ“ Log directory removed"
            fi
          fi
          echo ""
          
          # 6. Secure temporary directory cleanup
          echo "6ï¸âƒ£  Temporary File Cleanup"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          if [ -n "$SECURE_TMPDIR" ] && [ -d "$SECURE_TMPDIR" ]; then
            echo "   Cleaning secure temporary directory..."
            
            # Securely wipe any sensitive files
            find "$SECURE_TMPDIR" -type f -exec shred -vfz -n 1 {} \; 2>/dev/null || \
            find "$SECURE_TMPDIR" -type f -exec rm -f {} \; 2>/dev/null
            
            # Remove directory
            rm -rf "$SECURE_TMPDIR"
            echo "   âœ“ Secure temporary directory cleaned"
          fi
          
          # Check for other temporary OpenVPN files
          TEMP_FILES=$(find /tmp /var/tmp -name "openvpn-*" -o -name "*vpn*" 2>/dev/null | wc -l)
          if [ "$TEMP_FILES" -gt 0 ]; then
            echo "   âš ï¸ Found $TEMP_FILES temporary VPN-related file(s)"
            find /tmp /var/tmp -name "openvpn-*" -o -name "*vpn*" 2>/dev/null | head -n 10
            CLEANUP_ISSUES=$((CLEANUP_ISSUES + 1))
          else
            echo "   âœ“ No temporary VPN files found"
          fi
          echo ""
          
          # 7. Network configuration reset
          echo "7ï¸âƒ£  Network Configuration Reset"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          
          # Flush DNS cache
          if command -v resolvectl > /dev/null 2>&1; then
            sudo resolvectl flush-caches 2>/dev/null || true
            echo "   âœ“ DNS cache flushed"
          fi
          
          # Reset systemd-resolved
          if systemctl is-active --quiet systemd-resolved; then
            sudo systemctl restart systemd-resolved 2>/dev/null || true
            echo "   âœ“ systemd-resolved restarted"
          fi
          
          # Clear any VPN-related iptables rules (if any were added)
          # This is a safety measure
          sudo iptables -D INPUT -i "$VPN_INTERFACE" -j ACCEPT 2>/dev/null || true
          sudo iptables -D OUTPUT -o "$VPN_INTERFACE" -j ACCEPT 2>/dev/null || true
          echo "   âœ“ Firewall rules cleaned"
          echo ""
          
          # 8. Memory cleanup (clear sensitive data from RAM)
          echo "8ï¸âƒ£  Memory Cleanup"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          
          # Force garbage collection by dropping caches (requires root)
          echo "   Syncing filesystem..."
          sync
          
          # Drop page cache, dentries and inodes
          echo "   Clearing system caches..."
          sudo sh -c 'echo 3 > /proc/sys/vm/drop_caches' 2>/dev/null || true
          echo "   âœ“ System caches cleared"
          echo ""
          
          # 9. Final verification
          echo "9ï¸âƒ£  Final Verification"
          echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          
          VERIFICATION_PASSED=true
          
          # Check no OpenVPN processes
          if pgrep openvpn > /dev/null 2>&1; then
            echo "   âŒ OpenVPN processes still running"
            ps aux | grep [o]penvpn
            VERIFICATION_PASSED=false
          else
            echo "   âœ“ No OpenVPN processes running"
          fi
          
          # Check no VPN interfaces
          if ip link show "$VPN_INTERFACE" > /dev/null 2>&1; then
            echo "   âŒ VPN interface still exists"
            VERIFICATION_PASSED=false
          else
            echo "   âœ“ No VPN interfaces present"
          fi
          
          # Check no configuration files
          if [ -d "/etc/openvpn/client" ] || [ -f "$VPN_CONFIG_PATH" ]; then
            echo "   âŒ Configuration files still present"
            VERIFICATION_PASSED=false
          else
            echo "   âœ“ All configuration files removed"
          fi
          
          # Check no log files
          if [ -f "$VPN_LOG_PATH" ] || [ -f "$HEALTH_CHECK_LOG" ]; then
            echo "   âŒ Log files still present"
            VERIFICATION_PASSED=false
          else
            echo "   âœ“ All log files removed"
          fi
          
          # Check no leaked credentials
          if find /tmp /var/tmp $HOME -name "*.ovpn" 2>/dev/null | grep -q .; then
            echo "   âŒ Potential credential files found"
            VERIFICATION_PASSED=false
          else
            echo "   âœ“ No leaked credential files"
          fi
          
          echo ""
          
          # Summary
          echo "=== Cleanup Summary ==="
          if [ "$VERIFICATION_PASSED" = true ] && [ "$CLEANUP_ISSUES" -eq 0 ]; then
            echo "âœ… Cleanup completed successfully"
            echo "âœ… All security checks passed"
            echo "âœ… No traces of VPN connection remain"
          else
            echo "âš ï¸ Cleanup completed with $CLEANUP_ISSUES issue(s)"
            if [ "$VERIFICATION_PASSED" = false ]; then
              echo "âš ï¸ Some verification checks failed"
            fi
            echo ""
            echo "Please review the warnings above"
          fi
          
          echo ""
          echo "=== Cleanup Process Completed ==="

      - name: Upload cleanup verification report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: vpn-cleanup-verification
          path: |
            ${{ env.TEST_RESULTS_FILE }}
          retention-days: 7
          if-no-files-found: ignore
