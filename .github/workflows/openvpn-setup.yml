name: OpenVPN Connection Setup

on:
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'Enable debug mode'
        required: false
        default: 'false'
  schedule:
    # Run daily at 2 AM UTC (optional - can be adjusted or removed)
    - cron: '0 2 * * *'

jobs:
  openvpn-connection:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install OpenVPN
        run: |
          sudo apt-get update
          sudo apt-get install -y openvpn

      - name: Setup OpenVPN configuration
        run: |
          # Create OpenVPN config directory
          sudo mkdir -p /etc/openvpn/client
          
          # Write the main configuration file
          echo "${{ secrets.OPENVPNCONFIG }}" | sudo tee /etc/openvpn/client/config.ovpn > /dev/null
          
          # Write certificate files
          echo "${{ secrets.OPENVPNCACERT }}" | sudo tee /etc/openvpn/client/ca.crt > /dev/null
          echo "${{ secrets.OPENVPNCLIENTCERT }}" | sudo tee /etc/openvpn/client/client.crt > /dev/null
          echo "${{ secrets.OPENVPNPRIVATEKEY }}" | sudo tee /etc/openvpn/client/client.key > /dev/null
          
          # Set proper permissions
          sudo chmod 600 /etc/openvpn/client/*.key
          sudo chmod 644 /etc/openvpn/client/*.crt
          sudo chmod 644 /etc/openvpn/client/config.ovpn

      - name: Start OpenVPN connection
        run: |
          # Start OpenVPN in the background
          sudo openvpn --config /etc/openvpn/client/config.ovpn --daemon
          
          # Wait for connection to establish (max 30 seconds)
          echo "Waiting for VPN connection to establish..."
          for i in {1..30}; do
            if ip addr show tun0 > /dev/null 2>&1; then
              echo "VPN connection established successfully!"
              break
            fi
            sleep 1
          done

      - name: Verify VPN connection
        run: |
          # Check if tun0 interface exists
          if ip addr show tun0 > /dev/null 2>&1; then
            echo "✓ VPN interface (tun0) is up"
            ip addr show tun0
            
            # Show routing table
            echo ""
            echo "Routing table:"
            ip route
            
            # Test connectivity (optional - adjust or remove based on your VPN network)
            echo ""
            echo "Testing network connectivity..."
            # Add your specific connectivity tests here
            # Example: ping -c 3 <internal-network-ip>
          else
            echo "✗ VPN connection failed - tun0 interface not found"
            exit 1
          fi

      - name: Debug information (if enabled)
        if: github.event.inputs.debug_enabled == 'true'
        run: |
          echo "OpenVPN logs:"
          sudo journalctl -u openvpn --no-pager || cat /var/log/openvpn.log || echo "No logs available"
          
          echo ""
          echo "Network interfaces:"
          ip addr
          
          echo ""
          echo "OpenVPN process:"
          ps aux | grep openvpn

      # Add your custom steps here that require VPN access
      # Example:
      # - name: Run commands through VPN
      #   run: |
      #     # Your commands that need VPN access
      #     echo "Connected to VPN - running your tasks..."

      - name: Cleanup
        if: always()
        run: |
          # Stop OpenVPN
          sudo killall openvpn || true
          
          # Clean up sensitive files
          sudo rm -rf /etc/openvpn/client/
