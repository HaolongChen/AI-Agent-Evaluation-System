name: OpenVPN Connection Setup (Fixed)

on:
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'Enable debug mode with verbose logging'
        required: false
        default: 'false'
      connection_timeout:
        description: 'Connection timeout in seconds'
        required: false
        default: '60'

env:
  VPN_CONFIG_PATH: /tmp/openvpn/config.ovpn
  VPN_LOG_PATH: /tmp/openvpn/connection.log
  VPN_INTERFACE: tun0

jobs:
  openvpn-connection:
    runs-on: ubuntu-latest
    container:
      image: alpine:latest  
      options: --cap-add=NET_ADMIN --device=/dev/net/tun --privileged
    timeout-minutes: 20
    
    steps:
      - name: Checkout repository
        run: |
          apk add --no-cache git
          git clone https://github.com/${{ github.repository }} /workspace
          cd /workspace
          git checkout ${{ github.ref_name }}

      - name: Install OpenVPN and dependencies
        run: |
          set -e
          echo "=== Installing OpenVPN and Dependencies ==="
          
          # Install required packages
          apk add --no-cache openvpn bash curl iproute2 iputils
          
          echo "‚úì Packages installed successfully"
          
          # Verify installations
          echo ""
          echo "=== Version Information ==="
          openvpn --version | head -n 1
          ip -V
          bash --version | head -n 1
          echo ""

      - name: Create TUN device manually
        run: |
          set -e
          echo "=== Setting up TUN Device ==="
          
          # Create TUN device manually
          mkdir -p /dev/net
          mknod /dev/net/tun c 10 200 || true
          chmod 666 /dev/net/tun
          
          # Verify TUN device exists
          if [ -c /dev/net/tun ]; then
            echo "‚úì TUN device available: /dev/net/tun"
            ls -l /dev/net/tun
          else
            echo "‚ùå TUN device not found"
            exit 1
          fi
          echo ""

      - name: Setup OpenVPN configuration with robust file creation
        env:
          OPENVPN_SECRET: ${{ secrets.OPENVPN }}
        run: |
          set -e
          echo "=== OpenVPN Configuration Setup ==="
          
          # Create temporary directory first
          mkdir -p /tmp/openvpn
          chmod 700 /tmp/openvpn
          
          # Debug secret availability
          echo "Checking OPENVPN_SECRET environment variable..."
          if [ -z "$OPENVPN_SECRET" ]; then
            echo "::error::OPENVPN_SECRET environment variable is empty or not set"
            exit 1
          fi
          
          echo "‚úì OPENVPN_SECRET environment variable is present"
          
          # Create config file with explicit error handling
          echo "Creating OpenVPN config file..."
          echo "$OPENVPN_SECRET" > /tmp/openvpn/config.ovpn
          
          # Verify file exists
          if [[ ! -f /tmp/openvpn/config.ovpn ]]; then
            echo "::error::OpenVPN config file was not created!"
            exit 1
          fi
          
          echo "‚úì Config file exists"
          
          # Verify file has content  
          if [[ ! -s /tmp/openvpn/config.ovpn ]]; then
            echo "::error::OpenVPN config file is empty!"
            exit 1
          fi
          
          FILE_SIZE=$(stat -c%s /tmp/openvpn/config.ovpn)
          echo "‚úì Config file has content (${FILE_SIZE} bytes)"
          
          # Set proper permissions
          chmod 600 /tmp/openvpn/config.ovpn
          echo "Config file created successfully: $(ls -la /tmp/openvpn/config.ovpn)"
          
          # Validate configuration format
          echo ""
          echo "=== Configuration Validation ==="
          
          if grep -q "^remote " /tmp/openvpn/config.ovpn; then
            REMOTE_INFO=$(grep "^remote " /tmp/openvpn/config.ovpn | head -n 1)
            echo "‚úì Remote server: $REMOTE_INFO"
          else
            echo "‚ö†Ô∏è WARNING: No 'remote' directive found"
          fi
          
          if grep -q "<ca>" /tmp/openvpn/config.ovpn; then
            echo "‚úì CA certificate found (inline)"
          elif grep -q "^ca " /tmp/openvpn/config.ovpn; then
            echo "‚úì CA certificate reference found"
          else
            echo "‚ö†Ô∏è WARNING: No CA certificate found"
          fi
          
          # Add enhanced configuration directives
          echo "" >> /tmp/openvpn/config.ovpn
          echo "# Enhanced Configuration" >> /tmp/openvpn/config.ovpn
          echo "log-append $VPN_LOG_PATH" >> /tmp/openvpn/config.ovpn
          
          # Set verbosity based on debug mode
          if [ "${{ github.event.inputs.debug_enabled }}" = "true" ]; then
            echo "verb 4" >> /tmp/openvpn/config.ovpn
            echo "‚úì Debug logging enabled (verbosity 4)"
          else
            echo "verb 3" >> /tmp/openvpn/config.ovpn
          fi
          
          # Connection reliability improvements
          echo "persist-key" >> /tmp/openvpn/config.ovpn
          echo "persist-tun" >> /tmp/openvpn/config.ovpn
          echo "keepalive 10 60" >> /tmp/openvpn/config.ovpn
          echo "resolv-retry infinite" >> /tmp/openvpn/config.ovpn
          
          echo ""
          echo "‚úì Configuration setup completed successfully"

      - name: Start OpenVPN connection
        run: |
          set -e
          
          TIMEOUT=${{ github.event.inputs.connection_timeout || '60' }}
          
          echo "=== Starting OpenVPN Connection ==="
          echo "Configuration: $VPN_CONFIG_PATH"
          echo "Timeout: ${TIMEOUT}s"
          echo ""
          
          # Start OpenVPN in background
          openvpn --config "$VPN_CONFIG_PATH" --daemon --log "$VPN_LOG_PATH" --writepid /tmp/openvpn/openvpn.pid
          
          echo "‚úì OpenVPN daemon started"
          sleep 2
          
          # Wait for connection
          echo "Waiting for VPN connection to establish..."
          counter=0
          
          while [ $counter -lt $TIMEOUT ]; do
            # Check if process is still alive
            if [ -f /tmp/openvpn/openvpn.pid ]; then
              VPN_PID=$(cat /tmp/openvpn/openvpn.pid)
              if ! kill -0 "$VPN_PID" 2>/dev/null; then
                echo ""
                echo "‚ùå OpenVPN process died unexpectedly"
                echo ""
                echo "Log contents:"
                cat "$VPN_LOG_PATH" 2>/dev/null || echo "No logs available"
                exit 1
              fi
            fi
            
            # Check interface and IP assignment
            if ip addr show "$VPN_INTERFACE" > /dev/null 2>&1; then
              if ip addr show "$VPN_INTERFACE" | grep -q "inet "; then
                # Verify interface is UP
                if ip link show "$VPN_INTERFACE" | grep -q "state UP\|state UNKNOWN"; then
                  VPN_IP=$(ip addr show "$VPN_INTERFACE" | grep "inet " | awk '{print $2}')
                  echo ""
                  echo "‚úì VPN connection established after ${counter}s"
                  echo "  Interface: $VPN_INTERFACE"
                  echo "  IP Address: $VPN_IP"
                  
                  # Wait for routes to be configured
                  sleep 2
                  
                  if ip route | grep -q "$VPN_INTERFACE"; then
                    echo "‚úì VPN routes configured"
                    echo ""
                    echo "=== VPN Connection Established Successfully ==="
                    break
                  fi
                fi
              fi
            fi
            
            # Progress indicator
            if [ $((counter % 5)) -eq 0 ]; then
              echo -n "."
            fi
            
            counter=$((counter + 1))
            sleep 1
          done
          
          if [ $counter -ge $TIMEOUT ]; then
            echo ""
            echo "‚ùå Connection timeout after ${TIMEOUT}s"
            echo ""
            echo "Log contents:"
            cat "$VPN_LOG_PATH" 2>/dev/null || echo "No logs available"
            exit 1
          fi

      - name: Verify connection
        run: |
          set -e
          
          echo "=== VPN Connection Verification ==="
          echo ""
          
          # 1. Process verification
          echo "1Ô∏è‚É£  Process Status"
          if [ -f /tmp/openvpn/openvpn.pid ]; then
            VPN_PID=$(cat /tmp/openvpn/openvpn.pid)
            if kill -0 "$VPN_PID" 2>/dev/null; then
              echo "   ‚úì OpenVPN process running (PID: $VPN_PID)"
            else
              echo "   ‚ùå OpenVPN process not running"
              exit 1
            fi
          else
            echo "   ‚ùå PID file not found"
            exit 1
          fi
          echo ""
          
          # 2. Interface verification
          echo "2Ô∏è‚É£  Interface Status"
          if ip link show "$VPN_INTERFACE" > /dev/null 2>&1; then
            echo "   ‚úì VPN interface exists: $VPN_INTERFACE"
            IF_STATE=$(ip link show "$VPN_INTERFACE" | grep -oP 'state \K\w+')
            echo "   ‚úì Interface state: $IF_STATE"
            
            # Show interface details
            echo "   ‚úì Interface configuration:"
            ip addr show "$VPN_INTERFACE" | sed 's/^/     /'
          else
            echo "   ‚ùå VPN interface not found"
            exit 1
          fi
          echo ""
          
          # 3. Routing verification
          echo "3Ô∏è‚É£  Routing Status"
          VPN_ROUTES=$(ip route | grep "$VPN_INTERFACE" | wc -l)
          if [ "$VPN_ROUTES" -gt 0 ]; then
            echo "   ‚úì Found $VPN_ROUTES route(s) via $VPN_INTERFACE:"
            ip route | grep "$VPN_INTERFACE" | sed 's/^/     /'
          else
            echo "   ‚ö†Ô∏è No routes found for $VPN_INTERFACE"
          fi
          echo ""
          
          # 4. Connectivity test
          echo "4Ô∏è‚É£  Connectivity Test"
          if ping -c 3 -W 5 8.8.8.8 > /dev/null 2>&1; then
            echo "   ‚úì Connectivity test successful (8.8.8.8)"
          else
            echo "   ‚ö†Ô∏è Connectivity test failed"
          fi
          echo ""
          
          echo "‚úÖ VPN connection verified and ready"

      - name: Show logs (debug mode)
        if: always() && github.event.inputs.debug_enabled == 'true'
        run: |
          echo "=== OpenVPN Connection Log ==="
          cat "$VPN_LOG_PATH" 2>/dev/null || echo "No logs available"
          echo ""
          
          echo "=== Network Configuration ==="
          echo "Interfaces:"
          ip addr show
          echo ""
          echo "Routes:"
          ip route show
          echo ""

      # ============================================
      # üéØ YOUR CUSTOM STEPS GO HERE
      # ============================================
      # Add your tasks that require VPN access below
      
      - name: Example VPN task
        run: |
          echo "=== Example Task Through VPN ==="
          echo ""
          echo "‚úì VPN is connected and ready"
          echo "‚úì You can now access internal resources"
          echo ""
          echo "Add your custom steps here to:"
          echo "  - Access internal servers"
          echo "  - Deploy to private networks"
          echo "  - Run tests against internal services"
          echo ""

      # ============================================
      # üßπ CLEANUP
      # ============================================

      - name: Cleanup
        if: always()
        run: |
          set +e
          
          echo "=== Cleanup ==="
          
          # Stop OpenVPN
          if [ -f /tmp/openvpn/openvpn.pid ]; then
            VPN_PID=$(cat /tmp/openvpn/openvpn.pid)
            if kill -0 "$VPN_PID" 2>/dev/null; then
              echo "Stopping OpenVPN (PID: $VPN_PID)..."
              kill -TERM "$VPN_PID" 2>/dev/null || true
              sleep 2
              
              # Force kill if needed
              if kill -0 "$VPN_PID" 2>/dev/null; then
                kill -KILL "$VPN_PID" 2>/dev/null || true
              fi
              echo "‚úì OpenVPN stopped"
            fi
          fi
          
          # Remove interface
          if ip link show "$VPN_INTERFACE" > /dev/null 2>&1; then
            ip link delete "$VPN_INTERFACE" 2>/dev/null || true
            echo "‚úì Network interface removed"
          fi
          
          # Securely remove config file
          if [ -f "$VPN_CONFIG_PATH" ]; then
            shred -vfz -n 3 "$VPN_CONFIG_PATH" 2>/dev/null || rm -f "$VPN_CONFIG_PATH"
            echo "‚úì Configuration file securely removed"
          fi
          
          # Clean up temporary directory
          if [ -d /tmp/openvpn ]; then
            rm -rf /tmp/openvpn
            echo "‚úì Temporary directory cleaned"
          fi
          
          echo "‚úì Cleanup completed"
