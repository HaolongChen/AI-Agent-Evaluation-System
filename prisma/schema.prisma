generator client {
  provider = "prisma-client"
  output   = "../build/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum CopilotType {
  dataModel
  uiBuilder
  actionflow
  logAnalyzer
  agentBuilder
}

enum SessionStatus {
  running
  completed
  failed
  pending
}

enum EvaluationStatus {
  pending
  in_progress
  completed
  failed
}

enum RubricReviewStatus {
  pending
  approved
  rejected
  modified
}

model goldenSet {
  id                 Int                 @id @default(autoincrement())
  projectExId        String              @map("project_ex_id")
  schemaExId         String              @map("schema_ex_id")
  copilotType        CopilotType         @map("copilot_type")
  userInput          userInput[]         @relation()
  copilotOutput      copilotOutput[]     @relation()
  idealResponse      Json                @map("ideal_response")
  createdAt          DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy          String?             @map("created_by")
  isActive           Boolean[]           @default([false]) @map("is_active") // Are specific input and output in progress
  simulationIds      String[]            @default([]) @map("simulation_ids") // List of copilotSimulation IDs associated
  copilotSimulations copilotSimulation[]

  @@unique([projectExId, schemaExId, copilotType])
  @@index([id], map: "idx_golden_set_schema")
}

model userInput {
  id          Int        @id @default(autoincrement())
  description String?
  content     Json       @map("input_content") // JSON content of user input
  createdAt   DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy   String?    @map("created_by")
  goldenSet   goldenSet? @relation(fields: [id], references: [id])

  @@index([id], map: "idx_user_input_session")
}

model copilotOutput {
  id          Int        @id @default(autoincrement())
  description String?
  content     Json       @map("output_content") // JSON content of copilot output
  createdAt   DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy   String?    @map("created_by")
  goldenSet   goldenSet? @relation(fields: [id], references: [id])

  @@index([id], map: "idx_copilot_output_session")
}

// Execution Sessions (references copilot schema tables)
model copilotSimulation {
  id          Int           @id @default(autoincrement())
  goldenSetId Int           @map("golden_set_id")
  modelName   String        @map("model_name") // e.g., 'gpt-4', 'claude-3-opus'
  startedAt   DateTime      @default(now()) @map("started_at") @db.Timestamptz(6)
  completedAt DateTime?     @map("completed_at") @db.Timestamptz(6)
  status      SessionStatus @default(running)

  // Performance Metrics
  totalLatencyMs    Int?     @map("total_latency_ms")
  roundtripCount    Int?     @map("roundtrip_count")
  inputTokens       Int?     @map("input_tokens")
  outputTokens      Int?     @map("output_tokens")
  totalTokens       Int?     @map("total_tokens") // input_tokens + output_tokens + reasoning tokens
  contextPercentage Decimal? @map("context_percentage") @db.Decimal(5, 2) // % of max context window used

  // Metadata for HITL graph execution (stores threadId, skipHumanReview, etc.)
  metadata Json?

  // Relations
  goldenSet goldenSet         @relation(fields: [goldenSetId], references: [id])
  rubric    adaptiveRubric?
  result    evaluationResult?

  @@index([id], map: "idx_copilot_simulation_schema")
}

model rubricCriterion {
  id             Int                        @unique @default(autoincrement()) // Unique identifier for the criterion
  rubricId       Int                        @map("rubric_id")
  title          String                     @map("title")
  content        String                     @map("description")
  expectedAnswer Boolean                    @map("expected_answer")
  judgeRecords   adaptiveRubricJudgeRecord?
  rubric         adaptiveRubric             @relation(fields: [rubricId], references: [id])
  weight         Decimal                    @map("weight") @db.Decimal(5, 2)
}

// Adaptive Rubrics (AI-generated evaluation questions)
model adaptiveRubric {
  id           Int @id @default(autoincrement())
  simulationId Int @unique @map("simulation_id")

  // Rubric Content (structured to match LangGraph Rubric interface)
  version       String            @default("1.0")
  criteria      rubricCriterion[]
  totalWeight   Decimal           @map("total_weight") @db.Decimal(10, 2)
  modelProvider String?           @map("model_provider")

  // Status
  reviewStatus RubricReviewStatus @default(pending) @map("review_status")
  isActive     Boolean            @default(true) @map("is_active")

  // Timestamps (matching LangGraph Rubric interface)
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  reviewedAt DateTime? @map("reviewed_at") @db.Timestamptz(6)
  reviewedBy String?   @map("reviewed_by") // account ID of the reviewer

  // Relations
  simulation   copilotSimulation           @relation(fields: [simulationId], references: [id]) // user input and copilot output come from here
  judgeRecords adaptiveRubricJudgeRecord[]

  @@index([id], map: "idx_adaptive_rubric_session")
}

model feedback {
  id            Int     @id @default(autoincrement())
  answer        Boolean @map("answer") // true for positive feedback, false for negative
  comments      String? @db.Text
  judgeRecordId Int     @unique @map("judge_record_id")

  // Relations
  judgeRecord adaptiveRubricJudgeRecord @relation(fields: [judgeRecordId], references: [id])

  @@index([id], map: "idx_feedback_session")
}

// Rubric Judgments (human and agent evaluations)
model adaptiveRubricJudgeRecord {
  id               Int       @id @default(autoincrement())
  adaptiveRubricId Int       @map("adaptive_rubric_id")
  evaluatorType    String    @map("evaluator_type") // 'agent' or 'human' to match LangGraph Evaluation.evaluatorType
  accountId        String?   @map("account_id") // ID of the human judge (null for agent evaluations)
  criterionId      Int       @unique @map("criterion_id")
  feedback         feedback?
  overallScore     Decimal   @map("overall_score") @db.Decimal(5, 2)
  timestamp        DateTime  @default(now()) @map("timestamp") @db.Timestamptz(6)

  // Relations
  rubric    adaptiveRubric  @relation(fields: [adaptiveRubricId], references: [id])
  criterion rubricCriterion @relation(fields: [criterionId], references: [id])

  @@index([id], map: "idx_rubric_judge_rubric")
}

// Evaluation Results Summary (matching LangGraph FinalReport interface)
model evaluationResult {
  id           Int @id @default(autoincrement())
  simulationId Int @unique @map("simulation_id")

  evaluationStatus EvaluationStatus @default(pending) @map("evaluation_status")

  // FinalReport fields (matching LangGraph FinalReport interface)
  verdict       String   @default("needs_review") // 'pass', 'fail', 'needs_review'
  overallScore  Decimal  @map("overall_score") @db.Decimal(5, 2)
  summary       String   @db.Text
  discrepancies String[] @default([]) // Array of discrepancy descriptions
  generatedAt   DateTime @default(now()) @map("generated_at") @db.Timestamptz(6)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  simulation copilotSimulation @relation(fields: [simulationId], references: [id])
}
