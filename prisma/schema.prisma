generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum CopilotType {
  dataModel
  uiBuilder
  actionflow
  logAnalyzer
  agentBuilder
}

enum SessionStatus {
  running
  completed
  failed
  pending
}

enum EvaluationStatus {
  pending
  in_progress
  completed
  failed
}

enum RubricReviewStatus {
  pending
  approved
  rejected
  modified
}

enum ExpectedAnswer {
  yes
  no
}

model goldenSet {
  id              Int         @id @default(autoincrement())
  projectExId     String      @map("project_ex_id")
  schemaExId      String      @map("schema_ex_id")
  nextGoldenSetId Int?        @unique @map("next_golden_set_id")
  copilotType     CopilotType @map("copilot_type")
  description     String?
  promptTemplate  String      @map("prompt_template")
  // TODO: implement context if needed
  idealResponse   Json        @map("ideal_response")
  createdAt       DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy       String?     @map("created_by")
  isActive        Boolean     @default(true) @map("is_active")

  nextGoldenSet nextGoldenSet? @relation(fields: [nextGoldenSetId], references: [id])

  @@unique([projectExId, schemaExId, copilotType])
  @@index([schemaExId], map: "idx_golden_set_schema")
}

model nextGoldenSet {
  id             Int      @id @default(autoincrement())
  description    String?
  promptTemplate String   @map("prompt_template")
  idealResponse  Json     @map("ideal_response")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  createdBy      String?  @map("created_by")
  isActive       Boolean  @default(true) @map("is_active")

  goldenSet goldenSet?

  @@index([id], map: "idx_next_golden_set_id")
}

// Execution Sessions (references copilot schema tables)
model evaluationSession {
  id           Int           @id @default(autoincrement())
  projectExId  String        @map("project_ex_id")
  schemaExId   String        @map("schema_ex_id")
  copilotType  CopilotType   @map("copilot_type")
  modelName    String        @map("model_name") // e.g., 'gpt-4', 'claude-3-opus'
  sessionIdRef Int?          @map("session_id_ref") // Reference to copilot_session.id
  startedAt    DateTime      @default(now()) @map("started_at") @db.Timestamptz(6)
  completedAt  DateTime?     @map("completed_at") @db.Timestamptz(6)
  status       SessionStatus @default(running)

  // Performance Metrics
  totalLatencyMs    Int?     @map("total_latency_ms")
  roundtripCount    Int?     @map("roundtrip_count")
  inputTokens       Int?     @map("input_tokens")
  outputTokens      Int?     @map("output_tokens")
  totalTokens       Int?     @map("total_tokens") // input_tokens + output_tokens + reasoning tokens
  contextPercentage Decimal? @map("context_percentage") @db.Decimal(5, 2) // % of max context window used

  // Metadata for HITL graph execution (stores threadId, skipHumanReview, etc.)
  metadata Json?

  // Relations
  rubric adaptiveRubric?
  result evaluationResult?

  @@index([schemaExId], map: "idx_evaluation_session_schema")
}

// Adaptive Rubrics (AI-generated evaluation questions)
model adaptiveRubric {
  id          Int    @id @default(autoincrement())
  projectExId String @map("project_ex_id")
  schemaExId  String @map("schema_ex_id")
  sessionId   Int    @unique @map("session_id")

  // Rubric Content (structured to match LangGraph Rubric interface)
  rubricId      String  @map("rubric_id") // Rubric.id from LangGraph
  version       String  @default("1.0")
  criteria      Json    @map("criteria") // Array of RubricCriterion objects
  totalWeight   Decimal @map("total_weight") @db.Decimal(10, 2)
  copilotInput  String? @map("copilot_input") @db.Text
  copilotOutput String? @map("copilot_output") @db.Text
  modelProvider String? @map("model_provider")
  modelName     String? @map("model_name")

  // Status
  reviewStatus RubricReviewStatus @default(pending) @map("review_status")
  isActive     Boolean            @default(true) @map("is_active")

  // Timestamps (matching LangGraph Rubric interface)
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  reviewedAt DateTime? @map("reviewed_at") @db.Timestamptz(6)
  reviewedBy String?   @map("reviewed_by") // account ID of the reviewer

  // Relations
  session      evaluationSession           @relation(fields: [sessionId], references: [id])
  judgeRecords adaptiveRubricJudgeRecord[]

  @@index([sessionId], map: "idx_adaptive_rubric_session")
}

// Rubric Judgments (human and agent evaluations)
model adaptiveRubricJudgeRecord {
  id               Int      @id @default(autoincrement())
  adaptiveRubricId Int      @map("adaptive_rubric_id")
  evaluatorType    String   @map("evaluator_type") // 'agent' or 'human' to match LangGraph Evaluation.evaluatorType
  accountId        String?  @map("account_id") // ID of the human judge (null for agent evaluations)
  scores           Json     @map("scores") // Array of EvaluationScore objects (criterionId, score, reasoning, evidence)
  overallScore     Decimal  @map("overall_score") @db.Decimal(5, 2)
  summary          String   @db.Text
  timestamp        DateTime @default(now()) @map("timestamp") @db.Timestamptz(6)

  // Relations
  rubric adaptiveRubric @relation(fields: [adaptiveRubricId], references: [id])

  @@index([adaptiveRubricId], map: "idx_rubric_judge_rubric")
}

// Evaluation Results Summary (matching LangGraph FinalReport interface)
model evaluationResult {
  id          Int         @id @default(autoincrement())
  sessionId   Int         @unique @map("session_id")
  schemaExId  String      @map("schema_ex_id")
  copilotType CopilotType @map("copilot_type")
  modelName   String      @map("model_name") // e.g., 'gpt-4', 'claude-3-opus'

  evaluationStatus EvaluationStatus @default(pending) @map("evaluation_status")

  // FinalReport fields (matching LangGraph FinalReport interface)
  verdict          String   @default("needs_review") // 'pass', 'fail', 'needs_review'
  overallScore     Decimal  @map("overall_score") @db.Decimal(5, 2)
  summary          String   @db.Text
  detailedAnalysis String   @map("detailed_analysis") @db.Text
  discrepancies    String[] @default([]) // Array of discrepancy descriptions
  auditTrace       String[] @default([]) @map("audit_trace") // Array of audit log entries
  generatedAt      DateTime @default(now()) @map("generated_at") @db.Timestamptz(6)

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  session evaluationSession @relation(fields: [sessionId], references: [id])
}
